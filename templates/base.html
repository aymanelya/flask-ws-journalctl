<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>WS journalctl</title>
    <meta name="msapplication-TileColor" content="#206bc4" />
    <meta name="theme-color" content="#206bc4" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon" />
    <meta name="description" content="" />
    <!-- CSS files -->
    <link href="/static/css/tabler.min.css?1651267453" rel="stylesheet" />
  </head>
  <body class="theme-light">
    <div class="page">
      <header class="navbar navbar-expand-md navbar-light d-print-none">
        <div class="container-xl">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
            <a href=".">
              <img src="/static/logo.svg" width="110" height="32" alt="Tabler" class="navbar-brand-image" />
            </a>
          </h1>
          <div class="navbar-nav flex-row order-md-last">
            <div class="nav-item d-none d-md-flex me-3">
              <div class="btn-list">
                <a href="#" class="btn" target="_blank" rel="noreferrer">
                  <!-- Download SVG icon from http://tabler-icons.io/i/brand-github -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path
                      d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"
                    ></path>
                  </svg>
                  Source code
                </a>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="page-wrapper">
        <div class="container-xl">
          <!-- Page title -->
          <div class="page-header d-print-none">
            <div class="row g-2 align-items-center">
              <div class="col">
                <h2 class="page-title">
                  {{ data.page_title }}
                </h2>
              </div>
            </div>
          </div>
        </div>
        <div class="page-body">
          <div class="container-xl">
            <!-- Content here -->
            <div id="alertContainer" class="toast-container position-fixed bottom-0 end-0 p-2 m-4"></div>

            <div class="row g-3 align-items-center">
              <div class="col-auto">
                <span id="connectionIndicator" class="status-indicator status-red status-indicator-animated">
                  <span class="status-indicator-circle"></span>
                  <span class="status-indicator-circle"></span>
                  <span class="status-indicator-circle"></span>
                </span>
              </div>
              <div class="col">
                <h2 id="idConnectedTo" class="page-title">not connected</h2>
              </div>
              <div class="col-md-auto ms-auto d-print-none">
                <div class="btn-list">
                  <form class="">
                    <input type="text" id="endpoint" name="endpoint" value="{{ data.ws_url }}" class="form-control mb-2 mr-sm-2" />
                    <button type="button" class="btn btn-primary" onclick="connectToWS()">Connect to WS</button>
                    <button class="btn btn-ghost-red" type="button" onclick="closeConn()">Close connection</button>
                  </form>
                </div>
              </div>
            </div>

            <form>
              <div class="mb-3">
                <label for="journalctlUnit" class="form-label">Service name</label>
                <input type="text" class="form-control" id="journalctlUnit" placeholder="systemd-udevd.service" name="journalctlUnit" value="systemd-udevd.service" />
                <button class="btn btn-green mt-2" type="button" onclick="sendMsg()">Get journalctl data</button>
              </div>
            </form>
          </div>
        </div>
        <footer class="footer footer-transparent d-print-none">
          <div class="container-xl">
            <div class="row text-center align-items-center flex-row-reverse">
              <div class="col-lg-auto ms-lg-auto">
                <ul class="list-inline list-inline-dots mb-0">
                  <li class="list-inline-item"></li>
                </ul>
              </div>
              <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                <ul class="list-inline list-inline-dots mb-0">
                  <li class="list-inline-item">
                    Copyright Â© 2022
                    <a href="." class="link-secondary">Andrew Dorokhin</a>. All rights reserved.
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <!-- Libs JS -->
    <script src="/static/js/tabler.min.js?1651267453" defer=""></script>
    <script>
      function uid() {
        return (performance.now().toString(36) + Math.random().toString(36)).replace(/\./g, "");
      }

      function createToastAlert(parentElement, alertBadgeText, alertTitle, alertMessage) {
        /* Create base toast div */
        let toastAlert = document.createElement("div");
        toastAlert.classList.add("toast");
        toastAlert.classList.add("show");
        toastAlert.setAttribute("role", "alert");
        let id_attr = uid();
        toastAlert.setAttribute("id", id_attr);
        toastAlert.setAttribute("aria-live", "assertive");
        toastAlert.setAttribute("data-bs-animation", "true");
        toastAlert.setAttribute("aria-atomic", "true");

        /* Create toast header element */
        let toastHeader = document.createElement("div");
        toastHeader.classList.add("toast-header");

        /* Create badge for toast header */
        let toastHeaderBadge = document.createElement("span");
        toastHeaderBadge.classList.add("badge");
        toastHeaderBadge.classList.add("bg-purple-lt");
        let badgeText = document.createTextNode(alertBadgeText);
        toastHeaderBadge.appendChild(badgeText);
        toastHeader.appendChild(toastHeaderBadge);

        /* Create text for toast header */
        let toastHeaderText = document.createElement("strong");
        toastHeaderText.classList.add("me-auto");
        let toastHeaderTextContent = document.createTextNode(alertTitle);
        toastHeaderText.appendChild(toastHeaderTextContent);
        toastHeader.appendChild(toastHeaderText);

        /* Create text for toast header */
        let toastCloseButton = document.createElement("button");
        toastCloseButton.classList.add("ms-2");
        toastCloseButton.classList.add("btn-close");
        toastCloseButton.setAttribute("type", "button");
        toastCloseButton.setAttribute("data-bs-dismiss", "toast");
        toastCloseButton.setAttribute("aria-label", "Close");
        toastHeader.appendChild(toastCloseButton);
        toastAlert.appendChild(toastHeader);

        /* Create toast body element */
        let toastBody = document.createElement("div");
        toastBody.classList.add("toast-body");
        let toastBodyContent = document.createTextNode(alertMessage);
        toastBody.appendChild(toastBodyContent);
        toastAlert.appendChild(toastBody);

        parentElement.appendChild(toastAlert);

        function hideToast(toastId) {
          const toastElement = document.getElementById(toastId);
          toastElement.classList.remove("show");
        }
        function removeToast(toastId) {
          const toastElement = document.getElementById(toastId);
          toastElement.remove();
        }
        const toastHideTimeout = setTimeout(hideToast, 3000, id_attr);
        const toastDestroyTimeout = setTimeout(removeToast, 4000, id_attr);
      }

      const alertContainer = document.getElementById("alertContainer");

      let wsClient;

      function connectToWS() {
        const endpoint = document.getElementById("endpoint").value;
        if (wsClient !== undefined) {
          wsClient.close();
        }
        wsClient = new WebSocket(endpoint);

        wsClient.onmessage = function (event) {
          let msgSize;
          if (event.data.size === undefined) {
            msgSize = event.data.length;
          } else {
            msgSize = event.data.size;
          }
          let payload = JSON.parse(event.data);
          console.log("onmessage. size: " + msgSize + ", content: " + event.data);
          createToastAlert(alertContainer, payload.title, "", payload.message);
        };

        wsClient.onopen = function (evt) {
          console.log("WS connection established");
          createToastAlert(alertContainer, "WS", "connection", "WS connection established");
          const conIndicator = document.getElementById("connectionIndicator");
          conIndicator.classList.remove("status-red");
          conIndicator.classList.add("status-green");
          const connectedTo = document.getElementById("idConnectedTo");
          connectedTo.innerHTML = "Connected";
        };

        wsClient.onclose = function (evt) {
          console.log("WS connection closed");
          const conIndicator = document.getElementById("connectionIndicator");
          conIndicator.classList.remove("status-green");
          conIndicator.classList.add("status-red");
          const connectedTo = document.getElementById("idConnectedTo");
          connectedTo.innerHTML = "Not connected";
        };

        wsClient.onerror = function (evt) {
          console.log("Error!");
        };
      }

      function sendMsg() {
        let payload = document.getElementById("journalctlUnit").value;
        wsClient.send(
          JSON.stringify({
            name: payload,
            type: "journalctl",
          })
        );
      }

      function closeConn() {
        wsClient.close();
      }
    </script>
  </body>
</html>
